@model IEnumerable<GrupoMad.Models.Product>

@{
    ViewData["Title"] = "Productos";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold"><i class="bi bi-basket text-primary"></i> Productos</h2>
                    <p class="text-muted">Administra los productos de tu empresa</p>
                </div>
                <div>
                    <a asp-action="Create" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Crear Nuevo Producto
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Filtros -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros de Búsqueda</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Buscar por Nombre o SKU</label>
                            <input type="text" id="searchInput" class="form-control" placeholder="Escriba para buscar...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tipo de Producto</label>
                            <select id="productTypeFilter" class="form-select">
                                <option value="">Todos los tipos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tienda</label>
                            <select id="storeFilter" class="form-select">
                                <option value="">Todas las tiendas</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Estado</label>
                            <select id="statusFilter" class="form-select">
                                <option value="">Todos</option>
                                <option value="active">Activo</option>
                                <option value="inactive">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="button" id="clearFilters" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-x-circle"></i> Limpiar Filtros
                            </button>
                            <span id="resultsCount" class="ms-3 text-muted"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="productsTable">
    <thead>
        <tr>
            <th>SKU</th>
            <th>Nombre</th>
            <th>Tipo</th>
            <th>Tipo de Precio</th>
            <th>Tienda</th>
            <th>Colores</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody id="productsTableBody">
        @foreach (var item in Model)
        {
            <tr data-name="@item.Name?.ToLower()"
                data-sku="@item.SKU?.ToLower()"
                data-product-type="@item.ProductType?.Name"
                data-store="@(item.Store?.Name ?? "Global")"
                data-status="@(item.IsActive ? "active" : "inactive")">
                <td>@item.SKU</td>
                <td>@item.Name</td>
                <td>
                    @if (item.ProductType != null)
                    {
                        <span class="badge bg-info">@item.ProductType.Name</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary">Sin tipo</span>
                    }
                </td>
                <td>
                    @if (item.ProductType != null)
                    {
                        @switch (item.ProductType.PricingType)
                        {
                            case GrupoMad.Models.PricingType.PerSquareMeter:
                                @:Por m²
                                break;
                            case GrupoMad.Models.PricingType.PerUnit:
                                @:Por Unidad
                                break;
                            case GrupoMad.Models.PricingType.PerLinearMeter:
                                @:Por Metro Lineal
                                break;
                            case GrupoMad.Models.PricingType.PerRangeLength:
                                @:Por Rango de Largo
                                break;
                            case GrupoMad.Models.PricingType.PerRangeDimensions:
                                @:Por Rango de Dimensiones
                                break;
                        }
                    }
                </td>
                <td>
                    @if (item.Store != null)
                    {
                        <span class="badge bg-warning">@item.Store.Name</span>
                    }
                    else
                    {
                        <span class="badge bg-primary">Global</span>
                    }
                </td>
                <td>
                    @if (item.ProductColors != null && item.ProductColors.Any())
                    {
                        <span class="badge bg-secondary">@item.ProductColors.Count colores</span>
                    }
                    else
                    {
                        <span class="text-muted">Sin colores</span>
                    }
                </td>
                <td>
                    @if (item.IsActive)
                    {
                        <span class="badge bg-success">Activo</span>
                    }
                    else
                    {
                        <span class="badge bg-danger">Inactivo</span>
                    }
                </td>
                <td>
                    <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-info">Detalles</a>
                    <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-warning">Editar</a>
                    <a asp-action="ManageColors" asp-route-id="@item.Id" class="btn btn-sm btn-secondary">Colores</a>
                    <a asp-action="PricesByStore" asp-route-id="@item.Id" class="btn btn-sm btn-primary">Precios</a>
                    <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-danger">Eliminar</a>
                </td>
            </tr>
        }
    </tbody>
</table>
                <div id="noResultsMessage" class="text-center py-5" style="display: none;">
                    <i class="bi bi-search fs-1 text-muted d-block mb-3"></i>
                    <p class="text-muted">No se encontraron productos que coincidan con los filtros.</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Select2 CSS y JS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function() {
            // Recopilar opciones únicas para los filtros
            const productTypes = new Set();
            const stores = new Set();

            $('#productsTableBody tr').each(function() {
                const productType = $(this).data('product-type');
                const store = $(this).data('store');

                if (productType) productTypes.add(productType);
                if (store) stores.add(store);
            });

            // Poblar dropdown de Tipos de Producto
            productTypes.forEach(type => {
                $('#productTypeFilter').append(`<option value="${type}">${type}</option>`);
            });

            // Poblar dropdown de Tiendas
            stores.forEach(store => {
                $('#storeFilter').append(`<option value="${store}">${store}</option>`);
            });

            // Inicializar Select2
            $('#productTypeFilter').select2({
                theme: 'bootstrap-5',
                placeholder: 'Seleccione tipo...',
                allowClear: true,
                width: '100%'
            });

            $('#storeFilter').select2({
                theme: 'bootstrap-5',
                placeholder: 'Seleccione tienda...',
                allowClear: true,
                width: '100%'
            });

            $('#statusFilter').select2({
                theme: 'bootstrap-5',
                placeholder: 'Seleccione estado...',
                allowClear: true,
                width: '100%'
            });

            // Función de filtrado
            function filterTable() {
                const searchTerm = $('#searchInput').val().toLowerCase();
                const productTypeFilter = $('#productTypeFilter').val();
                const storeFilter = $('#storeFilter').val();
                const statusFilter = $('#statusFilter').val();

                let visibleCount = 0;

                $('#productsTableBody tr').each(function() {
                    const $row = $(this);
                    const name = $row.data('name') || '';
                    const sku = $row.data('sku') || '';
                    const productType = $row.data('product-type') || '';
                    const store = $row.data('store') || '';
                    const status = $row.data('status') || '';

                    let showRow = true;

                    // Filtro de búsqueda general (nombre o SKU)
                    if (searchTerm && !name.includes(searchTerm) && !sku.includes(searchTerm)) {
                        showRow = false;
                    }

                    // Filtro por tipo de producto
                    if (productTypeFilter && productType !== productTypeFilter) {
                        showRow = false;
                    }

                    // Filtro por tienda
                    if (storeFilter && store !== storeFilter) {
                        showRow = false;
                    }

                    // Filtro por estado
                    if (statusFilter && status !== statusFilter) {
                        showRow = false;
                    }

                    if (showRow) {
                        $row.show();
                        visibleCount++;
                    } else {
                        $row.hide();
                    }
                });

                // Mostrar mensaje si no hay resultados
                if (visibleCount === 0) {
                    $('#noResultsMessage').show();
                    $('#productsTable').hide();
                } else {
                    $('#noResultsMessage').hide();
                    $('#productsTable').show();
                }

                // Actualizar contador de resultados
                const totalCount = $('#productsTableBody tr').length;
                $('#resultsCount').text(`Mostrando ${visibleCount} de ${totalCount} productos`);
            }

            // Event listeners
            $('#searchInput').on('keyup', filterTable);
            $('#productTypeFilter').on('change', filterTable);
            $('#storeFilter').on('change', filterTable);
            $('#statusFilter').on('change', filterTable);

            // Botón para limpiar filtros
            $('#clearFilters').on('click', function() {
                $('#searchInput').val('');
                $('#productTypeFilter').val('').trigger('change');
                $('#storeFilter').val('').trigger('change');
                $('#statusFilter').val('').trigger('change');
                filterTable();
            });

            // Inicializar contador
            filterTable();
        });
    </script>
}
